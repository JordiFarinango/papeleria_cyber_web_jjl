
{% extends 'barra_navegacion/barra.html' %}
{% load custom_filters %}

{% block title %} Ver productos {% endblock %}

{% block content %}

<div class="mt-8">
  <h2 class="text-2xl font-semibold text-gray-800 mb-4">Productos Registrados</h2>

  <div class="mb-4">
    <a href="{% url 'exportar_productos_excel' %}" class="inline-flex items-center px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">Exportar productos (Excel)</a>
  </div>

  <div class="flex gap-2 items-end mb-3">
  <div class="flex-1">
    <label class="block text-sm text-gray-700 mb-1">Categoría</label>
    <select id="categoria-select-ver" class="w-full border rounded p-2">
      <option value="">-- Selecciona una categoría --</option>
      {% for categoria in categorias %}
      <option value="{{categoria.id}}">{{ categoria.nombre }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="flex-1">
    <label class="block text-sm text-gray-700 mb-1">Buscar por nombre</label>
    <input id="buscar-nombre-ver" type="text" class="w-full border rounded p-2" placeholder="Ej: lápiz, cuaderno...">
  </div>
</div>



  <div class="overflow-x-auto">
    <div class="bg-white rounded-2xl shadow-md p-4">
      <table class="min-w-full border-separate border-spacing-x-2 border-spacing-y-2 text-sm text-left text-gray-700">
        <thead>
          <tr class="text-gray-600 text-xs font-semibold uppercase tracking-wider">
            <th class="px-4 py-2">Foto</th>
            <th class="px-4 py-2">Nombre</th>
            <th class="px-4 py-2">Marca</th>
            <th class="px-4 py-2">Categoría</th>
            <th class="px-4 py-2">Descripción</th>
            <th class="px-4 py-2">Precio</th>
            <th class="px-4 py-2">Stock</th>
            <th class="px-4 py-2">Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-productos-ver">
          {% for producto in productos %}
            <tr class="hover:bg-gray-50 transition">
              <td class="px-4 py-2">
                {% if producto.foto %}
                  <img src="{{ producto.foto.url }}" alt="Imagen de {{ producto.nombre }}" class="w-16 h-16 object-cover rounded-md cursor-zoom-in" data-lightbox data-full="{{ producto.foto.url }}">
                {% else %}
                  <span class="text-gray-400 italic">Sin imagen</span>
                {% endif %}
              </td>
              <td class="px-4 py-2 font-semibold text-gray-900">{{ producto.nombre }}</td>
              <td class="px-4 py-2">{{ producto.marca.nombre }}</td>
              <td class="px-4 py-2">{{ producto.categoria.nombre }}</td>
              <td class="px-4 py-2 max-w-[100px] truncate" title="{{ producto.descripcion }}">{{ producto.descripcion }}</td>
              <td class="px-4 py-2">${{ producto.precio }}</td>
              <td class="px-4 py-2">{{ producto.stock }}</td>
              <td class="px-4 py-2">
                <div>
                  <button class="fa-solid fa-pen-to-square text-blue-600 hover:text-blue-800 cursor-pointer" 
                  onclick="modalEditarProducto(
                    '{{producto.id}}',
                    '{{producto.nombre}}',
                    '{{producto.marca.id}}',
                    '{{producto.categoria.id}}',
                    '{{producto.descripcion}}',
                    '{{producto.precio|decimal_point}}',
                    '{{producto.stock}}',
                    '{{ producto.foto.url }}'
                  )"></button>

                  <button class="fa-solid fa-trash text-red-600 hover:text-red-800 cursor-pointer" onclick="modalEliminarProducto('{{producto.id}}', '{{producto.nombre}}')"></button>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="px-4 py-4 text-center text-gray-500">No hay productos registrados.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div id="modalEliminar" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50"> 
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
          <h2 class="text-lg font-semibold mb-4 text-gray-800">Eliminar Producto</h2>
          <p class="mb-6 text-gray-600" id="modalTextoProductoEli"></p>
          <form action="{% url 'eliminar_producto' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" id="id_producto" name="id_producto">
            <div>
              <button type="button" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded" onclick="cerrarModal()">Cancelar</button>
              <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">Eliminar</button>
            </div>
          </form>
        </div>
      </div>

      <div id="modalEditar" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
          <h2 class="text-lg font-semibold mb-4 text-gray-800">Editar Proveedor</h2>
          <form action="{% url 'editar_producto'%}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="grid grid-cols-1 gap-4 mb-4">
              <input type="hidden" id="id_producto_editar" name="id_producto_editar">
              <input type="text" id="nombre" name="nombre" class="border p-2 rounded w-full">
              <textarea name="descripcion" id="descripcion" class="border p-2 rounded w-full"></textarea>
              <input type="number" id="stock" name="stock" class="border p-2 rounded w-full">
              <input type="number" step="0.01" min="0" id="precio" name="precio" class="border p-2 rounded w-full">
              <div>
                <label class="block text-sm font-medium text-gray-700">Marca</label>
                <select name="marca_id" id="marca_id"class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                  <option value="">Seleccione una marca</option>
                  {% for marca in marcas %}
                  <option value="{{marca.id}}">{{marca.nombre}}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
              <label class="block text-sm font-medium text-gray-700">Categoria</label>
              <select name="categoria_id" id="categoria_id" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
              <option value="">Seleccione una categoria</option>
              {% for categoria in categorias %}
              <option value="{{categoria.id}}">{{categoria.nombre}}</option>
              {% endfor %}
              </select>
              </div>

              <img id="preview_foto" src="" alt="Foto actual" class="w-32 h-32 object-cover mb-2">
              <input type="file" accept="image/*" id="foto_url" name="foto_url">
              <div>
                <button type="button" onclick="cerrarModalEditar()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancelar</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Actualizar</button>
              </div>
            </div>
          </form>
        </div>
      </div>

            <!-- Lightbox Imagen -->
      <div id="img-viewer" class="fixed inset-0 bg-gray-700/60 backdrop-blur-[1px] hidden z-[60]">
        <div class="w-full h-full flex items-center justify-center p-4">
          <img id="img-viewer-img"
              src=""
              alt="Vista previa"
              class="max-w-[90vw] max-h-[90vh] rounded-xl shadow-2xl cursor-zoom-out" />
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}
